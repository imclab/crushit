#!/usr/bin/env node

var crushIt = require('../lib/main'),
    commander = require('commander'),
    packagejson = require('../package.json'),
    path = require('path'),
    fs = require('fs'),
    directory = process.cwd(),
    website = '';
    
commander
  .version(packagejson.version)
  .usage('[options] <url ...>')
  .option('-b, --beautify', 'Beautify code? Default [false]')
  .option('-m, --max', 'Perform maximum optimisation? Default [false]')
  .option('-man, --mangle', 'Mangle names? Default [false]')    
  .option('-c, --comments', 'Include comments in output? Default [false]')
  .parse(process.argv);
 
if (commander.args.length > 0) {
    website = commander.args[0];
    
    console.log('Reading scripts from: ');
    console.log('  - %s', website); 
    console.log('');
    
    
    crushIt.squeeze({
        website: website,
        max: !!(commander.max),
        comments: !!(commander.comments),
        strict: !!(commander.strict),
        mangle: !!(commander.mangle),
        beautify: !!(commander.beautify)
    }, 
    function (error, code) {
        if (error) {
            throw error;
        }
        else {
            var filename = path.join(directory, 'script_' + (new Date().getTime()) + '.js');
        
            if (code) {
                fs.writeFile(filename, code, 'utf8', function () {
                    crushIt.echoMsg('Success!! Compiled script saved in ' + path.basename(filename));
                });
            }
            else {
                crushIt.echoMsg('Scripts not found!');
            }
        }
    });    
}
else {
    commander.help();
}
